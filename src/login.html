<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Signup - Lumina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lumina Core Scripts -->
    <script src="js/database.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/login-debug.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-text {
            background: linear-gradient(to right, #f59e0b, #fbbf24);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #light-icon, #dark-icon { display: none; }
        html.dark #dark-icon { display: block; }
        html:not(.dark) #light-icon { display: block; }
    </style>
    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-800 dark:text-gray-300 transition-colors duration-300">

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="absolute top-4 right-4 z-20">
             <button id="theme-toggle" class="p-2 rounded-lg bg-white/50 dark:bg-black/50 backdrop-blur-sm text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-800">
                <svg id="light-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="dark-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </div>
        
        <div class="max-w-md w-full space-y-8 bg-white/80 dark:bg-black/80 backdrop-blur-xl p-10 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800">
            <div>
                <a href="index.html" class="flex justify-center text-3xl font-bold">
                    <span class="gradient-text">Lumina</span> âœ¨
                </a>
                <h2 id="form-title" class="mt-6 text-center text-3xl font-extrabold text-gray-900 dark:text-white">
                    Sign in to your account
                </h2>
            </div>

            <!-- Tab Buttons -->
            <div class="flex justify-center rounded-lg bg-gray-200 dark:bg-gray-900 p-1">
                <button id="signin-btn" class="w-full py-2 px-4 rounded-md text-sm font-medium bg-white dark:bg-gray-800 text-amber-600 shadow">Sign In</button>
                <button id="signup-btn" class="w-full py-2 px-4 rounded-md text-sm font-medium text-gray-600 dark:text-gray-400">Sign Up</button>
            </div>

            <!-- Sign In Form -->
            <form id="signin-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="signin-email" class="sr-only">Email address</label>
                        <input id="signin-email" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 placeholder-gray-500 text-gray-900 dark:text-white rounded-t-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="signin-password" class="sr-only">Password</label>
                        <input id="signin-password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 placeholder-gray-500 text-gray-900 dark:text-white rounded-b-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="text-sm">
                        <a href="#" class="font-medium text-amber-600 hover:text-amber-500">
                            Forgot your password?
                        </a>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" id="signin-btn">
                        <span id="signin-text">Sign in</span>
                        <span id="signin-loading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
                
                <!-- Quick Login Helpers for Demo -->
                <div class="mt-4 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">Quick Login (Demo):</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button type="button" onclick="quickLogin('admin')" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Admin</button>
                        <button type="button" onclick="quickLogin('teacher')" class="text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">Teacher</button>
                        <button type="button" onclick="quickLogin('student')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Student</button>
                    </div>
                </div>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="mt-8 space-y-6 hidden">
                <div class="rounded-md shadow-sm space-y-3">
                     <div>
                        <label for="signup-name" class="sr-only">Full Name</label>
                        <input id="signup-name" name="name" type="text" autocomplete="name" required class="appearance-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 placeholder-gray-500 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="signup-email" class="sr-only">Email address</label>
                        <input id="signup-email" name="email" type="email" autocomplete="email" required class="appearance-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 placeholder-gray-500 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="signup-password" class="sr-only">Password</label>
                        <input id="signup-password" name="password" type="password" autocomplete="new-password" required class="appearance-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 placeholder-gray-500 text-gray-900 dark:text-white rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="Password">
                    </div>
                     <div>
                        <label for="role" class="sr-only">Role</label>
                        <select id="role" name="role" required class="appearance-none relative block w-full px-3 py-3 border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-300 rounded-md focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                            <option value="" disabled selected>Select your role</option>
                            <option value="student">Student</option>
                            <option value="teacher">Teacher</option>
                        </select>
                    </div>
                </div>

                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500" id="signup-btn">
                        <span id="signup-text">Create Account</span>
                        <span id="signup-loading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Quick login for demo purposes
        async function quickLogin(role) {
            const defaultUsers = {
                admin: { email: 'admin@lumina.com', password: 'admin123' },
                teacher: { email: 'teacher@lumina.com', password: 'teacher123' },
                student: { email: 'student@lumina.com', password: 'student123' }
            };
            
            const userData = defaultUsers[role];
            if (userData) {
                document.getElementById('signin-email').value = userData.email;
                document.getElementById('signin-password').value = userData.password;
                
                // Trigger form submission
                document.getElementById('signin-form').dispatchEvent(new Event('submit'));
            }
        }

        // Wait for database to be ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for scripts to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (typeof luminaAPI === 'undefined') {
                console.error('Lumina API not loaded');
                return;
            }

            // Check if user is already logged in and session is valid
            try {
                console.log('Checking for existing user session...');
                const currentUser = await luminaAPI.getCurrentUser();
                console.log('getCurrentUser result:', currentUser);
                
                if (currentUser && currentUser.id && currentUser.role) {
                    console.log('Valid user session found, redirecting to dashboard');
                    // Show a temporary message to user
                    document.body.innerHTML = '<div style="padding: 40px; text-align: center; font-family: Arial;">Redirecting to dashboard...</div>';
                    // Add a small delay to ensure proper redirect
                    setTimeout(() => {
                        luminaUI.redirectToDashboard(currentUser.role);
                    }, 1000);
                    return; // Don't setup form handlers if redirecting
                } else {
                    console.log('No valid session found, showing login form');
                }
            } catch (error) {
                console.log('No current user session or invalid session:', error);
                // Clear any invalid session data
                if (window.luminaAPI) {
                    try {
                        await luminaAPI.logout();
                        console.log('Cleared invalid session');
                    } catch (logoutError) {
                        console.log('Error clearing session:', logoutError);
                    }
                }
            }

            setupFormHandlers();
        });

        function setupFormHandlers() {
            const signinTabBtn = document.getElementById('signin-btn');
            const signupTabBtn = document.getElementById('signup-btn');
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const formTitle = document.getElementById('form-title');

            // Tab switching
            signinTabBtn.addEventListener('click', () => {
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                formTitle.textContent = 'Sign in to your account';
                signinTabBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-amber-600', 'shadow');
                signinTabBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                signupTabBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-amber-600', 'shadow');
                signupTabBtn.classList.add('text-gray-600', 'dark:text-gray-400');
            });

            signupTabBtn.addEventListener('click', () => {
                signupForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
                formTitle.textContent = 'Create a new account';
                signupTabBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-amber-600', 'shadow');
                signupTabBtn.classList.remove('text-gray-600', 'dark:text-gray-400');
                signinTabBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-amber-600', 'shadow');
                signinTabBtn.classList.add('text-gray-600', 'dark:text-gray-400');
            });

            // Form submission handlers
            signinForm.addEventListener('submit', handleSignIn);
            signupForm.addEventListener('submit', handleSignUp);
        }

        async function handleSignIn(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('signin-btn');
            const submitText = document.getElementById('signin-text');
            const submitLoading = document.getElementById('signin-loading');
            
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;

            // Show loading state
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                const user = await luminaAPI.login(email, password);
                
                luminaUI.showNotification(`Welcome back, ${user.name}!`, 'success');
                
                // Redirect to appropriate dashboard
                setTimeout(() => {
                    luminaUI.redirectToDashboard(user.role);
                }, 1000);
                
            } catch (error) {
                console.error('Login failed:', error);
                luminaUI.showNotification(error.message || 'Login failed', 'error');
            } finally {
                // Reset button state
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }

        async function handleSignUp(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('signup-btn');
            const submitText = document.getElementById('signup-text');
            const submitLoading = document.getElementById('signup-loading');
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.getElementById('role').value;

            // Validate form
            const errors = luminaUI.validateForm(document.getElementById('signup-form'));
            if (errors.length > 0) {
                luminaUI.showNotification(errors[0], 'error');
                return;
            }

            // Show loading state
            submitText.classList.add('hidden');
            submitLoading.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                // Create new user
                const userData = {
                    name: name,
                    email: email,
                    role: role,
                    status: 'active'
                };
                
                await luminaAPI.createUser(userData);
                
                // Login the new user
                const user = await luminaAPI.login(email, password);
                
                luminaUI.showNotification(`Account created successfully! Welcome, ${user.name}!`, 'success');
                
                // Redirect to appropriate dashboard
                setTimeout(() => {
                    luminaUI.redirectToDashboard(user.role);
                }, 1500);
                
            } catch (error) {
                console.error('Signup failed:', error);
                let errorMessage = 'Failed to create account';
                
                if (error.message.includes('email')) {
                    errorMessage = 'An account with this email already exists';
                }
                
                luminaUI.showNotification(errorMessage, 'error');
            } finally {
                // Reset button state
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>

